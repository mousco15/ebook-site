<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Ebooks</title>

  <!-- Styles de base Bootstrap (pour la mise en page propre) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Ton style -->
  <link rel="stylesheet" href="./custom.css?v=5">
</head>
<body class="bg-geo">

  <main class="container py-4">

    <!-- Barre de titre + session -->
    <header class="d-flex flex-wrap align-items-center justify-content-between mb-4">
      <h1 class="h2 m-0">➕ Ajouter / Gérer les Ebooks</h1>

      <div class="d-flex align-items-center gap-3">
        <div class="small text-muted">
          <div>Connecté en tant que</div>
          <strong id="whoami">...</strong>
        </div>
        <button id="btnLogout" class="btn btn-outline-primary">Se déconnecter</button>
      </div>
    </header>

    <!-- Boutons d’action -->
    <div class="mb-3 d-flex gap-2">
      <button id="btnShowAdd"   class="btn btn-primary">Ajouter</button>
      <button id="btnShowManage" class="btn btn-outline-secondary">Gérer</button>
    </div>

    <!-- ===== Section : AJOUT ===== -->
    <section id="secAdd" class="card shadow-sm mb-4">
      <div class="card-body">
        <h2 class="h5 mb-3">Ajouter un ebook</h2>

        <form id="addForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label">Titre *</label>
            <input name="title" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Auteur *</label>
            <input name="author" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea name="description" class="form-control" rows="3" placeholder="Résumé, points forts…"></textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Langue</label>
              <select name="language" class="form-select">
                <option value="fr" selected>Français</option>
                <option value="en">Anglais</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Prix (centimes)</label>
              <input name="price_cents" type="number" min="0" class="form-control" placeholder="ex: 990">
            </div>
          </div>

          <div class="mb-3 mt-3">
            <label class="form-label">Catégories (séparées par des virgules)</label>
            <input name="categories" class="form-control" placeholder="ex: business, entrepreneuriat">
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Couverture (JPG/PNG)</label>
              <!-- ⚠️ NOM EXACT attendus par le serveur -->
              <input name="cover" type="file" accept="image/*" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Fichier PDF *</label>
              <!-- ⚠️ NOM EXACT attendus par le serveur -->
              <input name="pdf" type="file" accept="application/pdf" class="form-control" required>
            </div>
          </div>

          <div class="mt-4">
            <button class="btn btn-primary">Enregistrer</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ===== Section : GESTION ===== -->
    <section id="secManage" class="card shadow-sm mb-4 d-none">
      <div class="card-body">
        <h2 class="h5 mb-3">Bibliothèque (Gérer)</h2>

        <!-- Recherche -->
        <form id="searchForm" class="row g-2 mb-3">
          <div class="col-sm-9">
            <input id="q" class="form-control" placeholder="Rechercher (titre, auteur, mots-clés…)">
          </div>
          <div class="col-sm-3 d-grid">
            <button class="btn btn-outline-primary">Rechercher</button>
          </div>
        </form>

        <!-- Liste -->
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Auteur</th>
                <th>Créé</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>

  <script>
    // --------- Protéger l’accès : vérifier la session au chargement ---------
    (async () => {
      try {
        const r = await fetch('/api/me', { credentials: 'include' });
        const me = await r.json();
        if (!me.user) {
          location.href = '/login.html';
          return;
        }
        document.getElementById('whoami').textContent = me.user;
      } catch (e) {
        console.error(e);
        location.href = '/login.html';
      }
    })();

    // --------- Toggle Ajouter/Gérer ----------
    const secAdd    = document.getElementById('secAdd');
    const secManage = document.getElementById('secManage');
    const btnAdd    = document.getElementById('btnShowAdd');
    const btnManage = document.getElementById('btnShowManage');

    function showAdd()   { secAdd.classList.remove('d-none'); secManage.classList.add('d-none'); }
    function showManage(){ secManage.classList.remove('d-none'); secAdd.classList.add('d-none'); loadList(); }

    btnAdd.addEventListener('click', showAdd);
    btnManage.addEventListener('click', showManage);

    // Au premier affichage, montrer "Ajouter"
    showAdd();

    // --------- Déconnexion ----------
    document.getElementById('btnLogout').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      location.href = '/login.html';
    });

    // --------- Soumission formulaire d’ajout ----------
    document.getElementById('addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      try {
        const res = await fetch('/api/ebooks', {
          method: 'POST',
          body: fd,
          credentials: 'include' // IMPORTANT pour la session
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.ok) {
          alert("Échec de l'envoi.");
          return;
        }
        alert('Ebook ajouté !');
        e.currentTarget.reset();
        showManage();
      } catch (err) {
        console.error(err);
        alert("Échec de l'envoi.");
      }
    });

    // --------- Chargement liste ----------
    async function loadList(q = '') {
      const url = q ? `/api/ebooks?q=${encodeURIComponent(q)}` : '/api/ebooks';
      const res = await fetch(url, { credentials: 'include' });
      const rows = await res.json();
      const tbody = document.getElementById('rows');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.title || ''}</td>
          <td>${r.author || ''}</td>
          <td>${(r.created_at || '').slice(0,16).replace('T',' ')}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" data-del="${r.id}">Supprimer</button>
          </td>
        </tr>
      `).join('');

      // suppression
      tbody.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!confirm('Supprimer cet ebook ?')) return;
          const id = btn.getAttribute('data-del');
          const r = await fetch('/api/ebooks/' + id, { method: 'DELETE', credentials: 'include' });
          const j = await r.json();
          if (j.ok) loadList(q);
        });
      });
    }

    // Recherche
    document.getElementById('searchForm').addEventListener('submit', (e) => {
      e.preventDefault();
      loadList(document.getElementById('q').value.trim());
    });
  </script>
</body>
</html>
