<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Ebooks</title>

  <!-- Styles globaux puis personnalisations (custom.css contient le fond géométrique) -->
  <link rel="stylesheet" href="styles.css?v=5">
  <link rel="stylesheet" href="custom.css?v=5">

  <style>
    /* Renforts de mise en page pour mobile */
    :root { --gap: 16px; }
    body { margin:0; }
    .container { max-width: 980px; margin: 0 auto; padding: var(--gap); }
    header.admin-top {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: var(--gap);
      padding: calc(var(--gap)*1.25) var(--gap) 0;
    }
    header.admin-top h1 {
      margin: 0;
      line-height: 1.05;
      font-size: clamp(26px, 5vw, 46px);
    }
    .who {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-self: end;
      flex-wrap: wrap;
      font-weight: 600;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 16px; border-radius: 10px; font-weight: 700;
      border: 2px solid #4a90e2; color: #1a5fb4; background: rgba(255,255,255,.75);
      cursor: pointer; text-decoration: none;
    }
    .btn:hover { filter: brightness(0.95); }

    main { padding: var(--gap); }
    .cards { display: grid; gap: var(--gap); grid-template-columns: 1fr; }
    @media (min-width: 820px) { .cards { grid-template-columns: 1fr 1fr; } }

    .card {
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
      backdrop-filter: blur(3px);
    }
    .card h2 { margin: 0 0 10px; font-size: 18px; }
    form .row { display: grid; gap: 10px; grid-template-columns: 1fr; margin-bottom: 10px; }
    @media (min-width: 620px) { form .row.two { grid-template-columns: 1fr 1fr; } }
    label { font-size: 13px; font-weight: 600; }
    input[type="text"], input[type="number"], textarea, select, input[type="file"] {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,.15);
      background: #fff;
    }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid rgba(0,0,0,.08); }
    .actions { display: flex; gap: 8px; }
    .muted { color: #666; font-size: 13px; }
  </style>
</head>
<body>

  <!-- EN-TÊTE -->
  <header class="admin-top">
    <h1>Ajouter / Gérer les Ebooks</h1>
    <div class="who">
      <span class="muted">Connecté en tant que</span>
      <span id="who">—</span>
      <button id="btnLogout" class="btn" type="button">Se déconnecter</button>
    </div>
  </header>

  <!-- CONTENU -->
  <main class="container">
    <div class="cards">
      <!-- AJOUT / ÉDITION -->
      <section class="card">
        <h2>Ajouter un ebook</h2>
        <form id="addForm" enctype="multipart/form-data">
          <div class="row two">
            <div>
              <label for="title">Titre *</label>
              <input id="title" name="title" type="text" required />
            </div>
            <div>
              <label for="author">Auteur *</label>
              <input id="author" name="author" type="text" required />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="description">Description</label>
              <textarea id="description" name="description" rows="3" placeholder="Résumé, points forts…"></textarea>
            </div>
          </div>

          <div class="row two">
            <div>
              <label for="language">Langue</label>
              <select id="language" name="language">
                <option value="fr" selected>Français</option>
                <option value="en">Anglais</option>
              </select>
            </div>
            <div>
              <label for="price_cents">Prix (centimes)</label>
              <input id="price_cents" name="price_cents" type="number" min="0" step="1" placeholder="ex: 990" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="categories">Catégories (séparées par des virgules)</label>
              <input id="categories" name="categories" type="text" placeholder="ex: business, entrepreneuriat" />
            </div>
          </div>

          <div class="row two">
            <div>
              <label for="cover">Couverture (JPG/PNG)</label>
              <input id="cover" name="cover" type="file" accept="image/*" />
            </div>
            <div>
              <label for="pdf">Fichier PDF *</label>
              <input id="pdf" name="pdf" type="file" accept="application/pdf" required />
            </div>
          </div>

          <div class="row">
            <button class="btn" type="submit">Enregistrer</button>
          </div>
        </form>
      </section>

      <!-- LISTE / GESTION -->
      <section class="card">
        <h2>Gérer les ebooks</h2>

        <div class="row">
          <input id="q" type="text" placeholder="Rechercher (titre, auteur, mots-clés…)" />
          <button id="btnSearch" class="btn" type="button">Rechercher</button>
        </div>

        <div class="row">
          <table id="grid">
            <thead>
              <tr>
                <th>Titre</th>
                <th>Auteur</th>
                <th class="muted">Créé</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody><!-- rempli en JS --></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <script>
    // ----------- Helpers
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => [...root.querySelectorAll(sel)];

    // ----------- 1) Vérifier la session au chargement
    (async () => {
      try {
        const r = await fetch('/api/me', { credentials: 'include' });
        const data = await r.json();
        if (!data.user) {
          location.href = '/login.html';
          return;
        }
        $('#who').textContent = data.user;
        // Charger la liste une fois authentifié
        await loadEbooks();
      } catch (e) {
        console.error('Erreur /api/me', e);
        location.href = '/login.html';
      }
    })();

    // ----------- 2) Déconnexion
    $('#btnLogout').addEventListener('click', async () => {
      try {
        await fetch('/api/logout', { method: 'POST', credentials: 'include' });
      } finally {
        location.href = '/login.html';
      }
    });

    // ----------- 3) Soumission du formulaire d’ajout
    $('#addForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      try {
        const r = await fetch('/api/ebooks', {
          method: 'POST',
          body: fd,
          credentials: 'include'
        });
        const json = await r.json();
        if (!r.ok || !json.ok) {
          alert('Erreur: ' + (json.error || r.status));
          return;
        }
        alert('Ebook ajouté !');
        e.currentTarget.reset();
        await loadEbooks();
      } catch (err) {
        console.error(err);
        alert("Échec de l'envoi.");
      }
    });

    // ----------- 4) Charger et afficher les ebooks
    async function loadEbooks(q = '') {
      const url = q ? `/api/ebooks?q=${encodeURIComponent(q)}` : '/api/ebooks';
      const r = await fetch(url, { credentials: 'include' });
      const rows = await r.json();

      const tbody = $('#grid tbody');
      tbody.innerHTML = '';

      if (!Array.isArray(rows) || !rows.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="muted">Aucun résultat.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(row.title || '')}</td>
          <td>${escapeHtml(row.author || '')}</td>
          <td class="muted">${(row.created_at || '').toString().slice(0, 16)}</td>
          <td class="actions">
            <!-- (Édition à venir) -->
            <button class="btn" data-del="${row.id}">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Wire des boutons supprimer
      $$('[data-del]').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-del');
          if (!confirm('Supprimer cet ebook ?')) return;
          const r = await fetch(`/api/ebooks/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          });
          const json = await r.json();
          if (!r.ok || !json.ok) {
            alert('Suppression impossible');
            return;
          }
          await loadEbooks($('#q').value.trim());
        });
      });
    }

    // ----------- 5) Recherche
    $('#btnSearch').addEventListener('click', () => {
      loadEbooks($('#q').value.trim());
    });
    $('#q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        loadEbooks($('#q').value.trim());
      }
    });

    function escapeHtml(s) {
      return (s ?? '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>
</body>
</html>
