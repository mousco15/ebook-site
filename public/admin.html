<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Ebooks</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
</head>
<body>
  <main class="container">
    <h1>âž• Ajouter / GÃ©rer les Ebooks</h1>
    <p id="who"></p>
    <p><button id="logoutBtn">Se dÃ©connecter</button></p>
    <form id="form" enctype="multipart/form-data">
      <div class="grid">
        <input name="title" placeholder="Titre *" required />
        <input name="author" placeholder="Auteur *" required />
      </div>
      <textarea name="description" placeholder="Description"></textarea>
      <div class="grid">
        <input name="language" placeholder="Langue (fr/en)" value="fr"/>
        <input name="categories" placeholder="CatÃ©gories (sÃ©parÃ©es par des virgules)"/>
        <input name="price_cents" type="number" placeholder="Prix (centimes) ex: 990"/>
      </div>
      <div class="grid">
        <label>Couverture (JPG/PNG)<input type="file" name="cover" accept="image/*"></label>
        <label>Fichier PDF *<input type="file" name="pdf" accept="application/pdf" required></label>
      </div>
      <button type="submit">Enregistrer</button>
    </form>

    <hr/>
    <h2>ðŸ“š Catalogue</h2>
    <div id="list"></div>
  </main>

  <script>
    const form = document.getElementById('form');

    async function me() {
      const res = await fetch('/api/me');
      const u = await res.json();
      if (!u.isAdmin) location.href = '/login.html';
      document.getElementById('who').textContent = 'ConnectÃ© en tant que ' + (u.email||'admin');
    }
    me();

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      location.href = '/login.html';
    });

    async function load() {
      const res = await fetch('/api/ebooks');
      const items = await res.json();
      const list = document.getElementById('list');
      list.innerHTML = items.map(b => `
        <article>
          <h3>${b.title} <small>â€” ${b.author}</small></h3>
          <p>${b.description || ''}</p>
          <p><strong>Langue:</strong> ${b.language} â€¢ <strong>CatÃ©gories:</strong> ${b.categories || '-'} â€¢ <strong>Prix:</strong> ${(b.price_cents||0)/100}</p>
          <p>
            <a href="/ebook.html?id=${b.id}">Voir</a> Â· <a href="#" onclick="edit(${b.id});return false;">Modifier</a> Â·
            <a href="#" onclick="del(${b.id});return false;">Supprimer</a>
          </p>
        </article>
      `).join('');
    }

    async function del(id) {
      if (!confirm('Supprimer cet ebook ?')) return;
      const res = await fetch('/api/ebooks/' + id, { method: 'DELETE' });
      const data = await res.json();
      if (data.error) alert(data.error); else load();
    }

    async function edit(id) {
      const res = await fetch('/api/ebooks/' + id);
      const b = await res.json();
      // Fill the form for edit
      for (const [k,v] of Object.entries({
        title:b.title, author:b.author, description:b.description, language:b.language, categories:b.categories, price_cents:b.price_cents
      })) {
        const el = form.querySelector(`[name="${k}"]`);
        if (el) el.value = v || '';
      }
      form.dataset.editId = id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Handle create vs update
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const id = form.dataset.editId;
      const method = id ? 'PUT' : 'POST';
      const url = id ? '/api/ebooks/' + id : '/api/ebooks';
      const res = await fetch(url, { method, body: fd });
      const data = await res.json();
      if (data.error) alert(data.error);
      else {
        alert(id ? 'Ebook modifiÃ© !' : 'Ebook ajoutÃ© !');
        form.reset(); delete form.dataset.editId; load();
      }
    });

    load();
  </script>
</body>
</html>