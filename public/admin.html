<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin — Ebooks</title>
  <link rel="stylesheet" href="/custom.css?v=10">
  <link rel="preload" as="image" href="/hero.jpg">
</head>
<body>
  <header class="container">
    <h1>Admin — Ebooks</h1>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span>Connecté : <strong id="whoami">…</strong></span>
      <button id="logoutBtn" type="button" class="btn-outline">Se déconnecter</button>
      <a href="/" style="margin-left:auto">← Retour au site</a>
    </div>
  </header>

  <main class="container" style="display:grid;gap:22px">
    <section class="card">
      <h2>Ajouter un ebook</h2>
      <form id="addForm" enctype="multipart/form-data">
        <label>Titre *</label><input name="title" required>
        <label>Auteur *</label><input name="author" required>
        <label>Description</label><textarea name="description"></textarea>
        <div class="filters" style="margin:10px 0">
          <select name="language">
            <option value="Français" selected>Français</option>
            <option value="Anglais">Anglais</option>
          </select>
          <input name="price_cents" type="number" min="0" value="0" placeholder="Prix (centimes)">
          <input name="categories" placeholder="Catégories (séparées par des virgules)">
        </div>
        <div class="filters" style="margin:10px 0">
          <input type="file" name="cover" accept=".jpg,.jpeg,.png">
          <input type="file" name="pdf" accept=".pdf" required>
        </div>
        <button type="submit">Enregistrer</button>
      </form>
    </section>

    <section class="card">
      <h2>Gérer</h2>
      <div class="filters" style="margin:8px 0">
        <input id="adminSearch" type="search" placeholder="Rechercher (titre, auteur, mots-clés…)">
        <button id="refreshBtn" type="button">Rafraîchir</button>
      </div>
      <div id="adminList">Chargement…</div>
      <nav class="pager">
        <button id="prev" disabled>Précédent</button>
        <button id="next" disabled>Suivant</button>
      </nav>
    </section>
  </main>

  <script>
    // utils
    const $ = (s, r=document)=> r.querySelector(s);
    function toast(m){ alert(m); }

    // session
    async function checkSession(){
      try{
        const r = await fetch('/api/me', { credentials:'include' });
        const j = await r.json();
        if(!j.user){ location.href = '/login.html'; return false; }
        $('#whoami').textContent = j.user;
        return true;
      }catch{ location.href = '/login.html'; return false; }
    }
    $('#logoutBtn').addEventListener('click', async ()=>{
      try{ await fetch('/api/logout', { method:'POST', credentials:'include' }); }catch{}
      location.href = '/login.html';
    });

    // ajout
    $('#addForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      try{
        const r = await fetch('/api/ebooks', { method:'POST', body:fd, credentials:'include' });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || j.ok !== true) throw new Error(j.error||'upload');
        toast('Ebook ajouté !');
        e.currentTarget.reset();
        state.page = 1; // retour page 1
        await loadAdmin();
      }catch(err){
        console.error(err);
        toast("Échec de l'envoi.");
      }
    });

    // liste admin + pagination
    const state = { page:1, pageSize:10, q:'' };
    function readAdminQ(){ return ($('#adminSearch')?.value || '').trim(); }

    async function loadAdmin(){
      const params = new URLSearchParams({
        page: String(state.page),
        pageSize: String(state.pageSize),
        q: readAdminQ()
      });
      const box = $('#adminList');
      box.textContent = 'Chargement…';
      try{
        const r = await fetch('/api/ebooks?' + params.toString(), { credentials:'include' });
        const data = await r.json();
        const items = Array.isArray(data) ? data : (data.items || []);
        renderAdmin(items);
        $('#prev').disabled = (data.page || state.page) <= 1;
        $('#next').disabled = !(data.hasNext || (data.pages ? (data.page < data.pages) : (items.length === state.pageSize)));
      }catch(err){
        console.error(err);
        box.textContent = 'Erreur de chargement.';
      }
    }

    function renderAdmin(rows){
      const box = $('#adminList');
      if(!rows || rows.length===0){ box.innerHTML = '<p>Aucun livre pour l’instant.</p>'; return; }
      box.innerHTML = rows.map(e => `
        <article class="item" style="display:flex;gap:12px;align-items:flex-start;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:rgba(255,255,255,.9);margin-bottom:10px">
          ${e.cover_path ? `<img src="${e.cover_path}" alt="" style="width:64px;height:96px;object-fit:cover;border-radius:6px">` : ''}
          <div style="flex:1">
            <div style="font-weight:700">${e.title || ''}</div>
            <div style="opacity:.75">${e.author || ''}</div>
            <div style="opacity:.7;font-size:.9em">${e.language || ''} • ${e.categories || ''}</div>
            ${e.pdf_path ? `<div style="margin-top:6px"><a href="${e.pdf_path}" target="_blank" rel="noopener">Ouvrir le PDF</a></div>` : ''}
          </div>
          <div>
            <button class="btn-outline" data-del="${e.id}">Supprimer</button>
          </div>
        </article>
      `).join('');

      box.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('Supprimer cet ebook ?')) return;
          const id = btn.getAttribute('data-del');
          try{
            const r = await fetch('/api/ebooks/' + id, { method:'DELETE', credentials:'include' });
            const j = await r.json().catch(()=> ({}));
            if(!r.ok || j.ok !== true){ toast('Suppression échouée'); return; }
            toast('Supprimé');
            await loadAdmin();
          }catch{ toast('Suppression échouée'); }
        });
      });
    }

    // events
    $('#adminSearch').addEventListener('input', ()=>{ state.page=1; loadAdmin(); });
    $('#refreshBtn').addEventListener('click', ()=> loadAdmin());
    $('#prev').addEventListener('click', ()=> { if(state.page>1){ state.page--; loadAdmin(); }});
    $('#next').addEventListener('click', ()=> { state.page++; loadAdmin(); });

    (async ()=>{
      if(await checkSession()) loadAdmin();
    })();
  </script>
</body>
</html>
